<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - TradeSync Pro</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- ‚úÖ reCAPTCHA v3 - Replace YOUR_SITE_KEY with your actual key -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LeJ0k4sAAAAAHbxCseOvn6FAmCDhAuw_X_UEkQC"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <span class="logo-icon">üìà</span>
                <h1>TradeSync Pro</h1>
            </div>
        </header>

        <div class="progress-bar">
            <div class="step completed"><div class="step-number">‚úì</div><span>Select Plan</span></div>
            <div class="step active"><div class="step-number">2</div><span>Your Details</span></div>
            <div class="step"><div class="step-number">3</div><span>Payment</span></div>
        </div>

        <main class="main-content">
            <div class="checkout-container">
                <div class="order-summary">
                    <h3>Order Summary</h3>
                    <div class="summary-item">
                        <span>Plan:</span>
                        <span id="planDays">-</span>
                    </div>
                    <div class="summary-item total">
                        <span>Total:</span>
                        <span id="planPrice">$- USDT</span>
                    </div>
                </div>

                <div class="checkout-form">
                    <h2>Enter Your Details</h2>
                    <form id="checkoutForm">
                        <!-- ‚úÖ HONEYPOT: Hidden field to catch bots -->
                        <div style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" aria-hidden="true">
                            <label for="website">Website (leave blank):</label>
                            <input type="text" id="website" name="website" tabindex="-1" autocomplete="off">
                        </div>
                        
                        <div class="form-group">
                            <label for="userName">Full Name *</label>
                            <input type="text" id="userName" name="userName" required
                                   placeholder="Enter your full name" minlength="2" maxlength="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="userEmail">Email Address *</label>
                            <input type="email" id="userEmail" name="userEmail" required
                                   placeholder="your@email.com">
                            <small>Your activation key will be sent to this email</small>
                            <div id="emailError" class="error-message" style="display: none; color: #e74c3c; margin-top: 5px; font-size: 0.9em;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Network *</label>
                            <div class="network-options">
                                <label class="network-option selected">
                                    <input type="radio" name="network" value="TRC20" checked>
                                    <span class="network-label">
                                        <strong>üî∑ TRC20 (Tron)</strong>
                                        <small>Lower fees (~$0.15)</small>
                                    </span>
                                </label>
                                <!--BEP20 DISABLED - BSCScan API requires paid subscription
                                <label class="network-option">
                                    <input type="radio" name="network" value="BEP20">
                                    <span class="network-label">
                                        <strong>üü° BEP20 (BSC)</strong>
                                        <small>Fast (~$0.30 fee)</small>
                                    </span>
                                </label>
                                -->
                            </div>
                            <small class="network-note">üí° TRC20 offers the lowest transaction fees</small>
                        </div>

                        <div class="form-actions">
                            <a href="index.html" class="btn btn-secondary">‚Üê Back</a>
                            <button type="submit" class="btn btn-primary" id="proceedBtn">
                                Proceed to Payment ‚Üí
                            </button>
                        </div>
                    </form>
                </div>

                <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                    <div class="spinner"></div>
                    <p id="loadingMessage">Creating your order...</p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>üîí Direct USDT payment - No third-party fees</p>
            <p class="footer-security">üõ°Ô∏è Protected by Google reCAPTCHA</p>
        </footer>
    </div>

    <script src="js/app.js"></script>
    <script>
        // ‚úÖ BLOCKED EMAIL DOMAINS (Disposable/Spam emails)
        const BLOCKED_DOMAINS = [
            'wirethings.net',
            'irethings.net',
            'ourtimesupport.com',
            'mailinator.com',
            'tempmail.com',
            'guerrillamail.com',
            '10minutemail.com',
            'throwaway.email',
            'temp-mail.org',
            'yopmail.com',
            'fakeinbox.com',
            'trashmail.com',
            'maildrop.cc',
            'getnada.com',
            'sharklasers.com',
            'grr.la',
            'guerrillamailblock.com',
            'pokemail.net',
            'spam4.me',
            'tempinbox.com',
            'dispostable.com',
            'mintemail.com',
            'mytemp.email',
            'emailondeck.com'
        ];

        // ‚úÖ Track form interaction
        let formInteractionStarted = false;
        let formInteractionTime = 0;
        
        document.addEventListener('DOMContentLoaded', () => {
            const planData = sessionStorage.getItem('selectedPlan');
            if (!planData) {
                window.location.href = 'index.html';
                return;
            }

            const plan = JSON.parse(planData);
            document.getElementById('planDays').textContent = `${plan.days} Days License`;
            document.getElementById('planPrice').textContent = `$${plan.price} USDT`;

            // Network selection highlight
            document.querySelectorAll('.network-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.network-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
            
            // ‚úÖ Track when user starts interacting with form
            const formInputs = document.querySelectorAll('#checkoutForm input');
            formInputs.forEach(input => {
                input.addEventListener('focus', () => {
                    if (!formInteractionStarted) {
                        formInteractionStarted = true;
                        formInteractionTime = Date.now();
                    }
                }, { once: true });
            });
            
            // ‚úÖ Real-time email validation
            const emailInput = document.getElementById('userEmail');
            const emailError = document.getElementById('emailError');
            
            emailInput.addEventListener('blur', () => {
                const email = emailInput.value.trim().toLowerCase();
                if (email) {
                    const domain = email.split('@')[1];
                    if (domain && BLOCKED_DOMAINS.includes(domain)) {
                        emailError.textContent = '‚ö†Ô∏è Please use a valid, permanent email address';
                        emailError.style.display = 'block';
                        emailInput.style.borderColor = '#e74c3c';
                    } else {
                        emailError.style.display = 'none';
                        emailInput.style.borderColor = '';
                    }
                }
            });
        });

        document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // ‚úÖ HONEYPOT CHECK: If filled, it's a bot
            const honeypot = document.getElementById('website').value;
            if (honeypot) {
                console.warn('üö´ Bot detected: Honeypot filled');
                // Silently fail for bot
                document.getElementById('loadingOverlay').style.display = 'flex';
                document.getElementById('loadingMessage').textContent = 'Processing...';
                await new Promise(resolve => setTimeout(resolve, 3000));
                alert('An error occurred. Please try again later.');
                document.getElementById('loadingOverlay').style.display = 'none';
                return;
            }

            const plan = JSON.parse(sessionStorage.getItem('selectedPlan'));
            const userName = document.getElementById('userName').value.trim();
            const userEmail = document.getElementById('userEmail').value.trim().toLowerCase();
            const network = document.querySelector('input[name="network"]:checked').value;

            // ‚úÖ VALIDATE EMAIL DOMAIN (Client-side check)
            const emailDomain = userEmail.split('@')[1];
            if (emailDomain && BLOCKED_DOMAINS.includes(emailDomain)) {
                const emailError = document.getElementById('emailError');
                emailError.textContent = '‚ùå Disposable email addresses are not allowed. Please use a permanent email.';
                emailError.style.display = 'block';
                document.getElementById('userEmail').focus();
                return;
            }

            // ‚úÖ VALIDATE NAME (Basic spam check)
            if (userName.length < 2 || userName.length > 100) {
                alert('Please enter a valid name (2-100 characters)');
                return;
            }
            
            // Check for suspicious patterns in name
            const suspiciousPatterns = /^[a-z]+\d+@|^test|^fake|^spam|^\d+$/i;
            if (suspiciousPatterns.test(userName)) {
                console.warn('‚ö†Ô∏è Suspicious name pattern:', userName);
            }

            // ‚úÖ BOT DETECTION: Check form interaction time
            let timeToSubmit = 0;
            if (formInteractionStarted) {
                timeToSubmit = Date.now() - formInteractionTime;
            }
            
            // If form submitted in less than 3 seconds, suspicious
            if (timeToSubmit > 0 && timeToSubmit < 3000) {
                console.warn('‚ö†Ô∏è Form submitted too quickly:', timeToSubmit, 'ms');
            }

            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingMessage').textContent = 'Creating your order...';
            document.getElementById('proceedBtn').disabled = true;

            try {
                // ‚úÖ GENERATE RECAPTCHA TOKEN
                let captchaToken = sessionStorage.getItem('captchaToken'); // From previous page
                
                // Generate new token for this action
                if (typeof grecaptcha !== 'undefined') {
                    try {
                        captchaToken = await grecaptcha.execute('6LeJ0k4sAAAAAHbxCseOvn6FAmCDhAuw_X_UEkQC', {action: 'create_order'});
                        console.log('‚úÖ reCAPTCHA token generated');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è reCAPTCHA generation failed:', error);
                        // Continue without token (backend will log warning)
                    }
                }

                // ‚úÖ SEND REQUEST WITH CAPTCHA TOKEN
                const response = await PaymentAPI.createOrder({
                    userName,
                    userEmail,
                    subscriptionDays: plan.days,
                    network,
                    captchaToken: captchaToken || undefined,  // ‚úÖ Include CAPTCHA token
                    // ‚úÖ Include behavioral data for backend analysis
                    metadata: {
                        timeToSubmit: timeToSubmit,
                        fastClick: sessionStorage.getItem('fastClick') === 'true',
                        suspiciousClicks: sessionStorage.getItem('suspiciousClicks') === 'true',
                        timeOnPreviousPage: plan.timeOnPage || 0
                    }
                });

                if (response.success) {
                    // Clear flags
                    sessionStorage.removeItem('captchaToken');
                    sessionStorage.removeItem('fastClick');
                    sessionStorage.removeItem('suspiciousClicks');
                    
                    sessionStorage.setItem('currentOrder', JSON.stringify({
                        orderId: response.orderId,
                        amount: response.amount,
                        walletAddress: response.walletAddress,
                        network: response.network,
                        expiresAt: response.expiresAt,
                        email: userEmail
                    }));

                    window.location.href = 'payment.html';
                } else {
                    throw new Error(response.message || 'Failed to create order');
                }
            } catch (error) {
                console.error('Order creation error:', error);
                
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('proceedBtn').disabled = false;
                
                // ‚úÖ USER-FRIENDLY ERROR MESSAGES
                let errorMessage = error.message;
                
                if (errorMessage.includes('CAPTCHA')) {
                    errorMessage = 'Security verification failed. Please try again.';
                } else if (errorMessage.includes('email')) {
                    errorMessage = 'Invalid email address. Please use a valid email.';
                } else if (errorMessage.includes('rate limit')) {
                    errorMessage = 'Too many requests. Please wait a few minutes and try again.';
                } else if (errorMessage.includes('network') || errorMessage.includes('timeout')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                }
                
                alert('‚ö†Ô∏è Error: ' + errorMessage);
            }
        });
        
        // ‚úÖ PREVENT FORM RESUBMISSION
        let isSubmitting = false;
        const originalFormSubmit = document.getElementById('checkoutForm').onsubmit;
        document.getElementById('checkoutForm').addEventListener('submit', (e) => {
            if (isSubmitting) {
                e.preventDefault();
                console.warn('‚ö†Ô∏è Form already submitting...');
                return false;
            }
            isSubmitting = true;
        });
    </script>
</body>
</html>
